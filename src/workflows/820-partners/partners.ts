import spaceTrim from 'spacetrim';
import { IWorkflowOptions } from '../IWorkflow';
import { pickPartnersForProject } from './organizations';

const PARTNERS_IN_MARKDOWN = /<!--Partners-->(?<badges>.*)<!--\/Partners-->/is;

export async function partners({
    projectUrl,
    projectName,
    projectOrg,
    modifyFiles,
    commit,
    branch,
}: IWorkflowOptions): Promise<void> {
    const organizations = pickPartnersForProject({
        projectUrl,
        projectOrg,
        projectName,
    });

    const partnersMarkdown =
        organizations.length === 0
            ? ``
            : spaceTrim(
                  (block) => `

                    <!--Partners-->
                    <!--⚠️WARNING: This section was generated by https://github.com/hejny/batch-project-editor/blob/main/src/workflows/820-partners/partners.ts so every manual change will be overwritten.-->

                    ## ✨ Partners


                    ${block(
                        organizations
                            .map(({ title, url, logoSrc }) =>
                                spaceTrim(`
                              <a href="${url.href}">
                                <img src="${logoSrc.href}" alt="${title} logo" width="50"  />
                              </a>
                        `),
                            )
                            .join('\n&nbsp;&nbsp;&nbsp;\n'),
                    )}


                    [Become a partner](https://www.pavolhejny.com/contact/)

                    <!--/Partners-->

                `,
              );

    await modifyFiles('README.md', async (readmeContent) => {
        if (PARTNERS_IN_MARKDOWN.test(readmeContent)) {
            return readmeContent.replace(PARTNERS_IN_MARKDOWN, partnersMarkdown);
        } else {
            return spaceTrim(
                (block) => `

                  ${block(readmeContent)}


                  ${block(partnersMarkdown)}

            `,
            );
        }
    });

    await commit('✨ Update partners');
}
